<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futu-Lite MVP (Stable)</title>
    <script src="lightweight-charts.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: #0b0f19; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { height: 48px; background: #111827; border-bottom: 1px solid #1f2937; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: bold; color: white; }
        .logo-icon { width: 24px; height: 24px; background: #f97316; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #22c55e; }
        .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }

        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        aside { width: 260px; background: #111827; border-right: 1px solid #1f2937; display: flex; flex-direction: column; flex-shrink: 0; }
        .tabs { display: flex; border-bottom: 1px solid #1f2937; }
        .tab { flex: 1; padding: 10px; text-align: center; color: #6b7280; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: #d1d5db; }
        .tab.active { color: white; border-bottom: 2px solid #f97316; background: #1f2937; }
        
        .watchlist { flex: 1; overflow-y: auto; }
        .stock-row { padding: 12px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .stock-row:hover { background: #1f2937; }
        .stock-row.active { background: #1f2937; border-left: 4px solid #f97316; }
        .stock-info { display: flex; flex-direction: column; }
        .symbol { font-weight: bold; font-size: 14px; color: white; }
        .name { font-size: 12px; color: #9ca3af; }
        .price-box { text-align: right; }
        .price { font-family: monospace; font-size: 14px; font-weight: bold; }
        .change { font-size: 12px; font-family: monospace; }
        .text-up { color: #ef4444; }
        .text-down { color: #22c55e; }

        main { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 1px; background: #000; padding: 1px; }
        
        .panel { background: #111827; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { position: absolute; top: 8px; left: 8px; z-index: 10; display: flex; gap: 8px; }
        .badge { background: rgba(31, 41, 55, 0.9); border: 1px solid #374151; color: #f97316; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; font-family: monospace; }
        .chart-div { width: 100%; height: 100%; }

        .ai-panel { padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .score { font-size: 72px; font-weight: 900; line-height: 1; margin: 10px 0; transition: all 0.3s; }
        .score.bullish { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
        .score.neutral { color: #eab308; text-shadow: 0 0 20px rgba(234, 179, 8, 0.2); }
        .score.bearish { color: #22c55e; text-shadow: 0 0 20px rgba(34, 197, 94, 0.2); }
        .ai-title { color: #6b7280; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .ai-stock-name { color: #f97316; font-size: 14px; font-weight: bold; margin-top: 4px; }
        .bar-container { width: 100%; max-width: 200px; margin-top: 10px; }
        .bar-row { display: flex; justify-content: space-between; font-size: 11px; color: #9ca3af; margin-bottom: 4px; }
        .progress-bg { height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .fill-red { background: #ef4444; }
        .fill-green { background: #22c55e; }
        .fill-yellow { background: #eab308; }

        @keyframes flashUp { 0% { background: rgba(239, 68, 68, 0.3); } 100% { background: transparent; } }
        @keyframes flashDown { 0% { background: rgba(34, 197, 94, 0.3); } 100% { background: transparent; } }
        .flash-up { animation: flashUp 0.5s; }
        .flash-down { animation: flashDown 0.5s; }

        @media (max-width: 768px) {
            aside { display: none; }
            main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr auto; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <div class="logo-icon">牛</div>
            <span>Futu-Lite <span style="font-weight:normal; color:#6b7280; font-size:12px;">v0.5 Stable</span></span>
        </div>
        <div class="status">
            <div class="dot"></div> LIVE
        </div>
    </header>

    <div class="main-container">
        <aside>
            <div class="tabs">
                <div class="tab active" data-filter="tw">台股</div>
                <div class="tab" data-filter="us">美股</div>
                <div class="tab" data-filter="all">全部</div>
            </div>
            <div class="watchlist" id="watchlist"></div>
        </aside>

        <main>
            <div class="panel">
                <div class="panel-header">
                    <span class="badge" id="badge-daily">2330 日線</span>
                    <span class="badge" style="color:#facc15">MA20</span>
                </div>
                <div id="chart-daily" class="chart-div"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><span class="badge" id="badge-1h">2330 60分</span></div>
                <div id="chart-1h" class="chart-div"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><span class="badge" id="badge-15m">2330 15分</span></div>
                <div id="chart-15m" class="chart-div"></div>
            </div>

            <div class="panel ai-panel" id="ai-panel">
                <div class="ai-title">AI 趨勢評分</div>
                <div class="ai-stock-name" id="ai-stock-name">2330 台積電</div>
                <div class="score bullish" id="ai-score">88</div>
                <div class="bar-container" id="ai-bars"></div>
            </div>
        </main>
    </div>

    <script>
        if (typeof LightweightCharts === 'undefined') {
            alert('圖表庫載入失敗！請檢查 lightweight-charts.js 是否存在');
        }

        // === Seeded Random ===
        function seededRandom(seed) {
            let s = seed;
            return function() {
                s = (s * 16807 + 0) % 2147483647;
                return (s - 1) / 2147483646;
            };
        }

        function hashStr(str) {
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        // === Stock Data ===
        const stocks = [
            { id: '2330', name: '台積電', price: 1080.00, market: 'tw', basePrice: 1080, volatility: 0.03, trend: 0.002 },
            { id: '2317', name: '鴻海', price: 215.50, market: 'tw', basePrice: 215, volatility: 0.025, trend: 0.001 },
            { id: '2454', name: '聯發科', price: 1385.00, market: 'tw', basePrice: 1385, volatility: 0.035, trend: 0.0015 },
            { id: '2308', name: '台達電', price: 415.00, market: 'tw', basePrice: 415, volatility: 0.028, trend: 0.001 },
            { id: '2881', name: '富邦金', price: 92.30, market: 'tw', basePrice: 92, volatility: 0.02, trend: -0.0005 },
            { id: '2882', name: '國泰金', price: 68.50, market: 'tw', basePrice: 68, volatility: 0.02, trend: 0.0003 },
            { id: '2603', name: '長榮', price: 198.00, market: 'tw', basePrice: 198, volatility: 0.04, trend: -0.001 },
            { id: '3711', name: '日月光投控', price: 168.50, market: 'tw', basePrice: 168, volatility: 0.03, trend: 0.001 },
            { id: '2412', name: '中華電', price: 132.50, market: 'tw', basePrice: 132, volatility: 0.012, trend: 0.0002 },
            { id: '2886', name: '兆豐金', price: 52.80, market: 'tw', basePrice: 52, volatility: 0.018, trend: 0.0004 },
            { id: '3037', name: '欣興', price: 215.00, market: 'tw', basePrice: 215, volatility: 0.04, trend: 0.002 },
            { id: '2303', name: '聯電', price: 52.10, market: 'tw', basePrice: 52, volatility: 0.03, trend: 0.0008 },
            { id: 'NVDA', name: '輝達', price: 186.94, market: 'us', basePrice: 186, volatility: 0.04, trend: 0.003 },
            { id: 'TSLA', name: '特斯拉', price: 435.20, market: 'us', basePrice: 435, volatility: 0.05, trend: 0.001 },
            { id: 'AAPL', name: '蘋果', price: 255.41, market: 'us', basePrice: 255, volatility: 0.02, trend: 0.001 },
        ];

        let activeStock = stocks[0];
        let activeFilter = 'tw';
        let charts = {};

        // === AI Score Generation ===
        function generateAIScore(stock) {
            const rng = seededRandom(hashStr(stock.id + '_ai'));
            const baseScore = Math.round(40 + rng() * 55); // 40-95
            const chip = Math.round(30 + rng() * 70);
            const tech = Math.round(25 + rng() * 75);
            const sentiment = Math.round(20 + rng() * 80);
            
            // Adjust by trend
            const trendBonus = stock.trend > 0.001 ? 10 : stock.trend > 0 ? 5 : stock.trend > -0.001 ? 0 : -8;
            const score = Math.min(99, Math.max(10, baseScore + trendBonus));
            
            const labels = (v) => v >= 70 ? '強勢' : v >= 40 ? '中立' : '弱勢';
            const techLabels = (v) => v >= 70 ? '多頭' : v >= 40 ? '盤整' : '空頭';
            const sentLabels = (v) => v >= 65 ? '樂觀' : v >= 35 ? '中立' : '悲觀';
            
            return {
                score,
                chip: { value: chip, label: labels(chip) },
                tech: { value: tech, label: techLabels(tech) },
                sentiment: { value: sentiment, label: sentLabels(sentiment) },
            };
        }

        // === Chart Data Generation ===
        function generateOHLC(stock, suffix, count, intervalSec) {
            const rng = seededRandom(hashStr(stock.id + '_' + suffix));
            const data = [];
            const volumeData = [];
            const maData = [];
            let time = Math.floor(Date.now() / 1000) - count * intervalSec;
            let price = stock.basePrice * (0.9 + rng() * 0.2);

            for (let i = 0; i < count; i++) {
                const open = price;
                const change = (rng() - 0.48 + stock.trend) * stock.volatility;
                const close = price * (1 + change);
                const high = Math.max(open, close) * (1 + rng() * 0.008);
                const low = Math.min(open, close) * (1 - rng() * 0.008);
                const vol = (rng() * 8000 + 2000) * (stock.basePrice / 100);

                data.push({ time: time + i * intervalSec, open, high, low, close });
                volumeData.push({
                    time: time + i * intervalSec,
                    value: vol,
                    color: close >= open ? 'rgba(239, 68, 68, 0.5)' : 'rgba(34, 197, 94, 0.5)'
                });

                if (i >= 20) {
                    let sum = 0;
                    for (let j = 0; j < 20; j++) sum += data[i - j].close;
                    maData.push({ time: time + i * intervalSec, value: sum / 20 });
                }
                price = close;
            }
            return { data, volumeData, maData };
        }

        // === Create / Update Charts ===
        function destroyCharts() {
            ['daily', '1h', '15m'].forEach(key => {
                if (charts[key]) {
                    charts[key].chart.remove();
                    delete charts[key];
                }
            });
        }

        function createChart(id, candleData, volumeData, maData, withVolume) {
            const container = document.getElementById(id);
            if (!container) return null;

            const chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#111827' }, textColor: '#9ca3af' },
                grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
                timeScale: { borderColor: '#374151', timeVisible: true, rightOffset: 5 },
                rightPriceScale: { borderColor: '#374151' },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });

            const series = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#ef4444', downColor: '#22c55e',
                borderUpColor: '#ef4444', borderDownColor: '#22c55e',
                wickUpColor: '#ef4444', wickDownColor: '#22c55e',
            });
            series.setData(candleData);

            if (withVolume && maData.length) {
                const maLine = chart.addSeries(LightweightCharts.LineSeries, { color: '#facc15', lineWidth: 1, priceLineVisible: false });
                maLine.setData(maData);

                const volSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                    priceFormat: { type: 'volume' },
                    priceScaleId: '',
                    scaleMargins: { top: 0.8, bottom: 0 },
                });
                volSeries.setData(volumeData);
            }

            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container) return;
                const { width, height } = entries[0].contentRect;
                chart.applyOptions({ width, height });
            }).observe(container);

            return { chart, series };
        }

        function switchStock(stock) {
            activeStock = stock;
            destroyCharts();

            // Generate data for 3 timeframes
            const daily = generateOHLC(stock, 'daily', 120, 86400);
            const hourly = generateOHLC(stock, '1h', 100, 3600);
            const min15 = generateOHLC(stock, '15m', 100, 900);

            charts.daily = createChart('chart-daily', daily.data, daily.volumeData, daily.maData, true);
            charts['1h'] = createChart('chart-1h', hourly.data, hourly.volumeData, hourly.maData, false);
            charts['15m'] = createChart('chart-15m', min15.data, min15.volumeData, min15.maData, false);

            // Update badges
            document.getElementById('badge-daily').textContent = stock.id + ' 日線';
            document.getElementById('badge-1h').textContent = stock.id + ' 60分';
            document.getElementById('badge-15m').textContent = stock.id + ' 15分';

            // Update AI panel
            const ai = generateAIScore(stock);
            document.getElementById('ai-stock-name').textContent = stock.id + ' ' + stock.name;
            const scoreEl = document.getElementById('ai-score');
            scoreEl.textContent = ai.score;
            scoreEl.className = 'score ' + (ai.score >= 70 ? 'bullish' : ai.score >= 45 ? 'neutral' : 'bearish');

            const colorClass = (v) => v >= 65 ? 'fill-red' : v >= 35 ? 'fill-yellow' : 'fill-green';
            const textClass = (v) => v >= 65 ? 'text-up' : v >= 35 ? '' : 'text-down';
            
            document.getElementById('ai-bars').innerHTML = `
                <div class="bar-row"><span>籌碼面</span><span class="${textClass(ai.chip.value)}">${ai.chip.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.chip.value)}" style="width: ${ai.chip.value}%"></div></div>
                <div class="bar-row"><span>技術面</span><span class="${textClass(ai.tech.value)}">${ai.tech.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.tech.value)}" style="width: ${ai.tech.value}%"></div></div>
                <div class="bar-row"><span>市場情緒</span><span class="${textClass(ai.sentiment.value)}">${ai.sentiment.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.sentiment.value)}" style="width: ${ai.sentiment.value}%"></div></div>
            `;

            renderList();
        }

        // === Watchlist ===
        function renderList() {
            const el = document.getElementById('watchlist');
            if (!el) return;
            el.innerHTML = '';
            const filtered = activeFilter === 'all' ? stocks : stocks.filter(s => s.market === activeFilter);
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = `stock-row ${s.id === activeStock.id ? 'active' : ''}`;
                div.id = 'row-' + s.id;
                const changeVal = ((s.price - s.basePrice) / s.basePrice * 100);
                const changeStr = (changeVal >= 0 ? '+' : '') + changeVal.toFixed(2) + '%';
                const changeClass = changeVal >= 0 ? 'text-up' : 'text-down';
                div.innerHTML = `
                    <div class="stock-info">
                        <span class="symbol">${s.id}</span>
                        <span class="name">${s.name}</span>
                    </div>
                    <div class="price-box">
                        <div class="price ${changeClass}" id="price-${s.id}">${s.price.toFixed(2)}</div>
                        <div class="change ${changeClass}" id="change-${s.id}">${changeStr}</div>
                    </div>
                `;
                div.addEventListener('click', () => switchStock(s));
                el.appendChild(div);
            });
        }

        // === Tabs ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeFilter = tab.dataset.filter;
                renderList();
            });
        });

        // === Price Simulation ===
        setInterval(() => {
            stocks.forEach(s => {
                const oldPrice = s.price;
                s.price += (Math.random() - 0.48 + s.trend) * s.volatility * s.price * 0.1;
                const priceEl = document.getElementById('price-' + s.id);
                const changeEl = document.getElementById('change-' + s.id);
                const rowEl = document.getElementById('row-' + s.id);
                if (priceEl) {
                    priceEl.innerText = s.price.toFixed(2);
                    priceEl.className = `price ${s.price >= oldPrice ? 'text-up' : 'text-down'}`;
                }
                if (changeEl) {
                    const cv = ((s.price - s.basePrice) / s.basePrice * 100);
                    changeEl.innerText = (cv >= 0 ? '+' : '') + cv.toFixed(2) + '%';
                    changeEl.className = `change ${cv >= 0 ? 'text-up' : 'text-down'}`;
                }
                if (rowEl) {
                    const cls = s.price > oldPrice ? 'flash-up' : 'flash-down';
                    rowEl.classList.add(cls);
                    setTimeout(() => rowEl.classList.remove(cls), 500);
                }
            });
        }, 800);

        // === Init ===
        switchStock(stocks[0]);
    </script>
</body>
</html>
