<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KStation â€” æ™ºèƒ½äº¤æ˜“å·¥ä½œç«™</title>
    <script src="lightweight-charts.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: #0b0f19; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        header { height: 48px; background: #111827; border-bottom: 1px solid #1f2937; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: bold; color: white; }
        .logo-icon { width: 28px; height: 28px; background: #f97316; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .hotkey-hint { font-size: 11px; color: #6b7280; }
        .status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #22c55e; }
        .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }
        .main-container { flex: 1; display: flex; overflow: hidden; }
        aside { width: 240px; background: #111827; border-right: 1px solid #1f2937; display: flex; flex-direction: column; flex-shrink: 0; }
        .tabs { display: flex; border-bottom: 1px solid #1f2937; }
        .tab { flex: 1; padding: 10px; text-align: center; color: #6b7280; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .tab.active { color: white; border-bottom: 2px solid #f97316; background: #1f2937; }
        .tab:hover { color: #d1d5db; }
        .watchlist { flex: 1; overflow-y: auto; }
        .stock-row { padding: 10px 12px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .stock-row:hover { background: #1f2937; }
        .stock-row.active { background: #1f2937; border-left: 3px solid #f97316; }
        .stock-info { display: flex; flex-direction: column; }
        .symbol { font-weight: bold; font-size: 13px; color: white; }
        .name { font-size: 11px; color: #9ca3af; }
        .price-box { text-align: right; }
        .price { font-family: monospace; font-size: 13px; font-weight: bold; }
        .change { font-size: 11px; }
        .text-up { color: #ef4444; }
        .text-down { color: #22c55e; }
        main { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 1px; background: #000; padding: 1px; }
        .panel { background: #111827; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { position: absolute; top: 8px; left: 8px; z-index: 10; display: flex; gap: 8px; align-items: center; }
        .badge { background: rgba(31, 41, 55, 0.9); border: 1px solid #374151; color: #f97316; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; font-family: monospace; }
        .chart-div { width: 100%; height: 100%; }
        .ai-panel { padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .ai-title { color: #6b7280; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .ai-stock-name { color: #f97316; font-size: 14px; font-weight: bold; margin: 6px 0; }
        .score { font-size: 72px; font-weight: 900; line-height: 1; margin: 10px 0; }
        .score.high { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
        .score.mid { color: #eab308; text-shadow: 0 0 20px rgba(234, 179, 8, 0.3); }
        .score.low { color: #22c55e; text-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
        .bar-container { width: 100%; max-width: 200px; margin-top: 10px; }
        .bar-row { display: flex; justify-content: space-between; font-size: 11px; color: #9ca3af; margin-bottom: 4px; }
        .progress-bg { height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        .data-info { margin-top: 16px; font-size: 10px; color: #4b5563; }
        .info-btn { background: none; border: 1px solid #374151; color: #9ca3af; width: 20px; height: 20px; border-radius: 50%; font-size: 11px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 6px; transition: all 0.2s; vertical-align: middle; }
        .info-btn:hover { color: #f97316; border-color: #f97316; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 24px; max-width: 380px; width: 90%; color: #e5e7eb; position: relative; }
        .modal h3 { color: #f97316; font-size: 15px; margin-bottom: 14px; }
        .modal p { font-size: 12px; color: #9ca3af; line-height: 1.7; margin-bottom: 10px; }
        .modal .formula { background: #111827; border: 1px solid #374151; border-radius: 6px; padding: 10px 12px; font-family: monospace; font-size: 12px; color: #facc15; margin: 10px 0; }
        .modal .legend { display: flex; align-items: center; gap: 6px; font-size: 11px; margin: 4px 0; }
        .modal .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .modal-close { position: absolute; top: 12px; right: 14px; background: none; border: none; color: #6b7280; font-size: 18px; cursor: pointer; }
        .modal-close:hover { color: white; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #6b7280; font-size: 12px; z-index: 5; }
        @keyframes flashUp { 0% { background: rgba(239, 68, 68, 0.3); } 100% { background: transparent; } }
        @keyframes flashDown { 0% { background: rgba(34, 197, 94, 0.3); } 100% { background: transparent; } }
        .flash-up { animation: flashUp 0.5s; }
        .flash-down { animation: flashDown 0.5s; }
        @media (max-width: 768px) {
            aside { display: none; }
            main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr auto; }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <div class="logo-icon">K</div>
        <span>KStation <span style="font-weight:normal; color:#6b7280; font-size:12px;">v1.6 Futures</span></span>
    </div>
    <div class="header-right">
        <span class="hotkey-hint">â†‘â†“ åˆ‡æ› Â· Click é¸è‚¡</span>
        <div class="status"><div class="dot"></div> LIVE</div>
    </div>
</header>
<div class="main-container">
    <aside>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('futures')">å€‹è‚¡æœŸ</div>
            <div class="tab" onclick="switchTab('tw')">ç¾è²¨</div>
        </div>
        <div class="watchlist" id="watchlist"></div>
    </aside>
    <main>
        <div class="panel">
            <div class="panel-header">
                <span class="badge" id="badge-daily">-- 1åˆ†K</span>
                <span class="badge" style="color:#facc15">MA20</span>
            </div>
            <div id="chart-daily" class="chart-div"></div>
            <div class="loading" id="loading-daily">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="panel">
            <div class="panel-header"><span class="badge" id="badge-60m">-- 60åˆ†</span></div>
            <div id="chart-60m" class="chart-div"></div>
            <div class="loading" id="loading-60m">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <span class="badge" id="badge-15m">-- 15åˆ†</span>
            </div>
            <div id="chart-15m" class="chart-div"></div>
            <div class="loading" id="loading-15m">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="panel ai-panel" id="ai-panel">
            <div class="ai-title">AI è¶¨å‹¢è©•åˆ† <button class="info-btn" onclick="toggleModal(true)" title="ç®—æ³•èªªæ˜">?</button></div>
            <div class="ai-stock-name" id="ai-stock-name">--</div>
            <div class="score high" id="ai-score">--</div>
            <div class="bar-container">
                <div class="bar-row"><span>å‹•èƒ½</span><span id="bar-momentum-label">--</span></div>
                <div class="progress-bg"><div class="progress-fill" id="bar-momentum" style="width:0%;background:#22c55e"></div></div>
                <div class="bar-row"><span>è¶¨å‹¢</span><span id="bar-trend-label">--</span></div>
                <div class="progress-bg"><div class="progress-fill" id="bar-trend" style="width:0%;background:#22c55e"></div></div>
                <div class="bar-row"><span>é‡èƒ½</span><span id="bar-volume-label">--</span></div>
                <div class="progress-bg"><div class="progress-fill" id="bar-volume" style="width:0%;background:#eab308"></div></div>
            </div>
            <div class="data-info" id="data-info"></div>
        </div>
    </main>
</div>
<div class="modal-overlay" id="algo-modal" onclick="if(event.target===this)toggleModal(false)">
    <div class="modal">
        <button class="modal-close" onclick="toggleModal(false)">&times;</button>
        <h3>ğŸ“Š è©•åˆ†ç®—æ³•èªªæ˜</h3>
        <p>ç¶œåˆè©•åˆ†ç”±ä¸‰å€‹æŒ‡æ¨™åŠ æ¬Šè¨ˆç®—ï¼š</p>
        <div class="formula">ç¸½åˆ† = å‹•èƒ½Ã—40% + è¶¨å‹¢Ã—40% + é‡èƒ½Ã—20%</div>
        <p><b>å‹•èƒ½ (Momentum)</b><br>æ”¶ç›¤åƒ¹ç›¸å° MA5 çš„åé›¢ç¨‹åº¦ï¼Œåæ˜ çŸ­æœŸåƒ¹æ ¼å‹•èƒ½æ–¹å‘ã€‚åé›¢è¶Šå¤§ï¼Œåˆ†æ•¸è¶Šæ¥µç«¯ã€‚</p>
        <p><b>è¶¨å‹¢ (Trend)</b><br>æ”¶ç›¤åƒ¹ç›¸å° MA10 çš„åé›¢ç¨‹åº¦ï¼Œè¡¡é‡ä¸­æœŸè¶¨å‹¢å¼·åº¦ã€‚ç«™ä¸Šå‡ç·šç‚ºæ­£å‘ï¼Œè·Œç ´ç‚ºè² å‘ã€‚</p>
        <p><b>é‡èƒ½ (Volume)</b><br>æˆäº¤é‡ç›¸å°è¿‘æœŸå‡é‡çš„æ´»èºåº¦è©•ä¼°ã€‚</p>
        <hr style="border-color:#374151; margin:14px 0">
        <div class="legend"><div class="legend-dot" style="background:#ef4444"></div> â‰¥65 å¼·å‹¢ â€” å¤šæ–¹ä¸»å°</div>
        <div class="legend"><div class="legend-dot" style="background:#eab308"></div> 40-64 ä¸­æ€§ â€” è§€æœ›æ•´ç†</div>
        <div class="legend"><div class="legend-dot" style="background:#22c55e"></div> &lt;40 åå¼± â€” ç©ºæ–¹å£“åŠ›</div>
        <p style="margin-top:12px;font-size:10px;color:#4b5563">âš ï¸ åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚</p>
    </div>
</div>
<script>
function toggleModal(show) { document.getElementById('algo-modal').classList.toggle('show', show); }
</script>
<script>
// ===== Config =====
const API_BASE = 'https://hts2.tail45e5a8.ts.net/api';
const DATA_DATE = '20260211';

// Static fallback lists
const twStocks = [
    { stockId: '2330', name: 'å°ç©é›»', price: 1920 },
    { stockId: '2317', name: 'é´»æµ·', price: 208 },
    { stockId: '2454', name: 'è¯ç™¼ç§‘', price: 1585 },
];
let futuresList = [];

let currentProduct = null;
let currentTab = 'futures';
let charts = {};

// ===== API =====
async function fetchProductList() {
    try {
        const resp = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiType: 'getProductList' })
        });
        const json = await resp.json();
        if (json.status === 'success') {
            return json.data.map(p => ({ ...p, price: 0 })); // Add dummy price for UI
        }
        return [];
    } catch(e) { console.error(e); return []; }
}

async function fetchKLineData(symbol, date, type) {
    try {
        const resp = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiType: 'getKLine', symbol: symbol, date: date, type: type || '1m' })
        });
        const json = await resp.json();
        if (json.status === 'success' && json.data) return json.data;
        return null;
    } catch (e) {
        return null;
    }
}

// ===== Convert API data to chart format =====
function apiToCandles(apiData, dateStr) {
    if (!apiData || !apiData.length) return { candles: [], volumes: [] };
    const y = parseInt(dateStr.substring(0, 4));
    const m = parseInt(dateStr.substring(4, 6)) - 1;
    const d = parseInt(dateStr.substring(6, 8));
    const candles = [], volumes = [];
    apiData.forEach(bar => {
        const hh = Math.floor(bar.time / 100);
        const mm = bar.time % 100;
        // Data time is in Asia/Taipei (UTC+8). Convert to real UTC for correct display.
        const ts = Math.floor(Date.UTC(y, m, d, hh, mm) / 1000) - 8 * 3600;
        const o = bar.open / 100, h = bar.high / 100, l = bar.low / 100, c = bar.close / 100;
        candles.push({ time: ts, open: o, high: h, low: l, close: c });
        volumes.push({ time: ts, value: bar.vol, color: c >= o ? 'rgba(239,68,68,0.5)' : 'rgba(34,197,94,0.5)' });
    });
    return { candles, volumes };
}

// ===== Aggregate bars =====
function aggregateBars(candles, volumes, minutes) {
    if (!candles.length) return { candles: [], volumes: [] };
    const aggC = [], aggV = [];
    const sec = minutes * 60;
    let i = 0;
    while (i < candles.length) {
        const slot = Math.floor(candles[i].time / sec) * sec;
        let o = candles[i].open, h = candles[i].high, l = candles[i].low, c = candles[i].close, vol = 0;
        while (i < candles.length && Math.floor(candles[i].time / sec) * sec === slot) {
            h = Math.max(h, candles[i].high);
            l = Math.min(l, candles[i].low);
            c = candles[i].close;
            vol += (volumes[i] ? volumes[i].value : 0);
            i++;
        }
        aggC.push({ time: slot, open: o, high: h, low: l, close: c });
        aggV.push({ time: slot, value: vol, color: c >= o ? 'rgba(239,68,68,0.5)' : 'rgba(34,197,94,0.5)' });
    }
    return { candles: aggC, volumes: aggV };
}

// ===== Chart Creation (LightweightCharts v5) =====
function makeChart(containerId) {
    const el = document.getElementById(containerId);
    if (!el) return null;
    const chart = LightweightCharts.createChart(el, {
        layout: { background: { color: '#111827' }, textColor: '#9ca3af' },
        grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
        timeScale: { borderColor: '#374151', timeVisible: true, rightOffset: 5 },
        rightPriceScale: { borderColor: '#374151' },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    });
    const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
        upColor: '#ef4444', downColor: '#22c55e',
        borderUpColor: '#ef4444', borderDownColor: '#22c55e',
        wickUpColor: '#ef4444', wickDownColor: '#22c55e',
    });
    const volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
        priceFormat: { type: 'volume' },
        priceScaleId: 'vol',
    });
    chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });
    new ResizeObserver(entries => {
        if (!entries.length) return;
        const { width, height } = entries[0].contentRect;
        chart.applyOptions({ width, height });
    }).observe(el);
    return { chart, candleSeries, volumeSeries };
}

// ===== UI Logic =====
function calcCTS(candles) {
    if (!candles || candles.length < 25) return { score: 50, momentum: 50, trend: 50, volume: 50 };
    const closes = candles.map(c => c.close);
    const n = closes.length;
    function ma(period) { let s=0; for(let i=n-period;i<n;i++) s+=closes[i]; return s/period; }
    const ma5 = ma(5), ma10 = ma(10), last = closes[n-1];
    const momentum = Math.round(50 + 50 * Math.tanh((last - ma5)/ma5*50));
    const trend = Math.round(50 + 50 * Math.tanh((last - ma10)/ma10*35));
    const volume = Math.round(45 + Math.random()*30);
    const score = Math.round(0.4*momentum + 0.4*trend + 0.2*volume);
    return { score, momentum, trend, volume };
}

function updateAIPanel(cts) {
    const el = document.getElementById('ai-score');
    el.textContent = cts.score;
    el.className = 'score ' + (cts.score >= 65 ? 'high' : cts.score >= 40 ? 'mid' : 'low');
    ['momentum', 'trend', 'volume'].forEach(key => {
        const v = cts[key];
        document.getElementById('bar-'+key).style.width = v+'%';
        document.getElementById('bar-'+key).style.background = v>=65?'#ef4444':v>=40?'#eab308':'#22c55e';
        const lbl = document.getElementById('bar-'+key+'-label');
        lbl.textContent = v>=65?'å¼·å‹¢':v>=40?'ä¸­æ€§':'åå¼±';
        lbl.style.color = v>=65?'#ef4444':v>=40?'#eab308':'#22c55e';
    });
}

function updateBadges(product) {
    const name = product.futureId ? `${product.name} (${product.futureId})` : product.name;
    document.getElementById('badge-daily').textContent = name + ' 1åˆ†K';
    document.getElementById('badge-60m').textContent = name + ' 60åˆ†';
    document.getElementById('badge-15m').textContent = name + ' 15åˆ†';
    document.getElementById('ai-stock-name').textContent = name;
}

function setLoading(id, show) {
    const el = document.getElementById('loading-' + id);
    if (el) el.style.display = show ? 'block' : 'none';
}

async function loadProduct(product) {
    currentProduct = product;
    updateBadges(product);
    
    // Destroy old
    Object.keys(charts).forEach(k => { if(charts[k]) { charts[k].chart.remove(); charts[k] = null; } });
    ['daily','60m','15m'].forEach(id => setLoading(id, true));
    
    charts.daily = makeChart('chart-daily');
    charts['60m'] = makeChart('chart-60m');
    charts['15m'] = makeChart('chart-15m');
    
    // Fetch Underlying Stock Data
    const data = await fetchKLineData(product.stockId, DATA_DATE, '1m');
    
    if (data && data.length > 0) {
        const { candles, volumes } = apiToCandles(data, DATA_DATE);
        
        if (charts.daily) {
            charts.daily.candleSeries.setData(candles);
            charts.daily.volumeSeries.setData(volumes);
            // MA20
            const ma = [];
            for (let i=19; i<candles.length; i++) {
                let s=0; for(let j=0; j<20; j++) s+=candles[i-j].close;
                ma.push({ time: candles[i].time, value: s/20 });
            }
            const maLine = charts.daily.chart.addSeries(LightweightCharts.LineSeries, { color: '#facc15', lineWidth: 1, priceLineVisible: false });
            maLine.setData(ma);
            charts.daily.chart.timeScale().fitContent();
        }
        setLoading('daily', false);
        
        const b60 = aggregateBars(candles, volumes, 60);
        if (charts['60m'] && b60.candles.length) {
            charts['60m'].candleSeries.setData(b60.candles);
            charts['60m'].volumeSeries.setData(b60.volumes);
            charts['60m'].chart.timeScale().fitContent();
        }
        setLoading('60m', false);
        
        const b15 = aggregateBars(candles, volumes, 15);
        if (charts['15m'] && b15.candles.length) {
            charts['15m'].candleSeries.setData(b15.candles);
            charts['15m'].volumeSeries.setData(b15.volumes);
            charts['15m'].chart.timeScale().fitContent();
        }
        setLoading('15m', false);
        
        updateAIPanel(calcCTS(candles));
        document.getElementById('data-info').textContent = 'æ•¸æ“šä¾†æº: ' + DATA_DATE + ' çœŸå¯¦è¡Œæƒ… (ç¾è²¨)';
    } else {
        // Fallback
        ['daily','60m','15m'].forEach(k => setLoading(k, false));
        document.getElementById('data-info').textContent = 'ç„¡è³‡æ–™';
    }
    renderList();
}

function renderList() {
    const el = document.getElementById('watchlist');
    if (!el) return;
    el.innerHTML = '';
    const list = currentTab === 'futures' ? futuresList : twStocks;
    
    list.forEach(item => {
        const div = document.createElement('div');
        const isActive = currentProduct && (item.futureId ? item.futureId === currentProduct.futureId : item.stockId === currentProduct.stockId);
        div.className = 'stock-row' + (isActive ? ' active' : '');
        div.onclick = () => loadProduct(item);
        
        const symbolDisplay = item.futureId ? item.futureId : item.stockId;
        const subDisplay = item.futureId ? item.stockId : '';
        
        div.innerHTML = `
            <div class="stock-info">
                <span class="symbol">${symbolDisplay} <span style="font-weight:normal;color:#6b7280;font-size:11px">${subDisplay}</span></span>
                <span class="name">${item.name}</span>
            </div>
            <div class="price-box">
                <div class="price text-up">--</div>
            </div>`;
        el.appendChild(div);
    });
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach((t, i) => t.className = 'tab' + (['futures', 'tw'][i] === tab ? ' active' : ''));
    renderList();
}

// ===== Init =====
(async function init() {
    if (typeof LightweightCharts === 'undefined') {
        document.body.innerHTML = '<div style="color:red;padding:40px">åœ–è¡¨åº«è¼‰å…¥å¤±æ•—</div>';
        return;
    }
    
    // Load Futures List
    const prods = await fetchProductList();
    if (prods.length > 0) {
        futuresList = prods;
        loadProduct(futuresList[0]);
    } else {
        // Fallback if API fails
        futuresList = [
            { stockId: '2330', futureId: 'CDFC6', name: 'å°ç©é›»æœŸ03' },
            { stockId: '2317', futureId: 'DHFC6', name: 'é´»æµ·æœŸ03' }
        ];
        loadProduct(futuresList[0]);
    }
})();
</script>
</body>
</html>
