<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futu-Lite MVP (Stable)</title>
    <script src="lightweight-charts.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: #0b0f19; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { height: 48px; background: #111827; border-bottom: 1px solid #1f2937; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: bold; color: white; }
        .logo-icon { width: 24px; height: 24px; background: #f97316; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #22c55e; }
        .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }

        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        aside { width: 260px; background: #111827; border-right: 1px solid #1f2937; display: flex; flex-direction: column; flex-shrink: 0; }
        .tabs { display: flex; border-bottom: 1px solid #1f2937; }
        .tab { flex: 1; padding: 10px; text-align: center; color: #6b7280; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: #d1d5db; }
        .tab.active { color: white; border-bottom: 2px solid #f97316; background: #1f2937; }
        
        .watchlist { flex: 1; overflow-y: auto; }
        .stock-row { padding: 12px; border-bottom: 1px solid #1f2937; display: flex; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .stock-row:hover { background: #1f2937; }
        .stock-row.active { background: #1f2937; border-left: 4px solid #f97316; }
        .stock-info { display: flex; flex-direction: column; }
        .symbol { font-weight: bold; font-size: 14px; color: white; }
        .name { font-size: 12px; color: #9ca3af; }
        .price-box { text-align: right; }
        .price { font-family: monospace; font-size: 14px; font-weight: bold; }
        .change { font-size: 12px; font-family: monospace; }
        .text-up { color: #ef4444; }
        .text-down { color: #22c55e; }

        main { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 1px; background: #000; padding: 1px; }
        
        .panel { background: #111827; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { position: absolute; top: 8px; left: 8px; z-index: 10; display: flex; gap: 8px; }
        .badge { background: rgba(31, 41, 55, 0.9); border: 1px solid #374151; color: #f97316; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; font-family: monospace; }
        .chart-div { width: 100%; height: 100%; }

        .ai-panel { padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .score { font-size: 72px; font-weight: 900; line-height: 1; margin: 10px 0; transition: all 0.3s; }
        .score.bullish { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
        .score.neutral { color: #eab308; text-shadow: 0 0 20px rgba(234, 179, 8, 0.2); }
        .score.bearish { color: #22c55e; text-shadow: 0 0 20px rgba(34, 197, 94, 0.2); }
        .ai-title { color: #6b7280; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
        .ai-stock-name { color: #f97316; font-size: 14px; font-weight: bold; margin-top: 4px; }
        .bar-container { width: 100%; max-width: 200px; margin-top: 10px; }
        .bar-row { display: flex; justify-content: space-between; font-size: 11px; color: #9ca3af; margin-bottom: 4px; }
        .progress-bg { height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .fill-red { background: #ef4444; }
        .fill-green { background: #22c55e; }
        .fill-yellow { background: #eab308; }

        @keyframes flashUp { 0% { background: rgba(239, 68, 68, 0.3); } 100% { background: transparent; } }
        @keyframes flashDown { 0% { background: rgba(34, 197, 94, 0.3); } 100% { background: transparent; } }
        .flash-up { animation: flashUp 0.5s; }
        .flash-down { animation: flashDown 0.5s; }

        @media (max-width: 768px) {
            aside { display: none; }
            main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr 1fr auto; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <div class="logo-icon">Áâõ</div>
            <span>Futu-Lite <span style="font-weight:normal; color:#6b7280; font-size:12px;">v0.7 Â§öÈÄ±ÊúüÂÖ±ÊåØ</span></span>
        </div>
        <div class="status">
            <div class="dot"></div> LIVE
        </div>
    </header>

    <div class="main-container">
        <aside>
            <div class="tabs">
                <div class="tab active" data-filter="tw">Âè∞ËÇ°</div>
                <div class="tab" data-filter="us">ÁæéËÇ°</div>
                <div class="tab" data-filter="all">ÂÖ®ÈÉ®</div>
            </div>
            <div class="watchlist" id="watchlist"></div>
        </aside>

        <main>
            <div class="panel">
                <div class="panel-header">
                    <span class="badge" id="badge-daily">2330 Êó•Á∑ö</span>
                    <span class="badge" style="color:#facc15">MA20</span>
                </div>
                <div id="chart-daily" class="chart-div"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><span class="badge" id="badge-1h">2330 60ÂàÜ</span></div>
                <div id="chart-1h" class="chart-div"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><span class="badge" id="badge-15m">2330 15ÂàÜ</span></div>
                <div id="chart-15m" class="chart-div"></div>
            </div>

            <div class="panel ai-panel" id="ai-panel">
                <div class="ai-title">AI Ë∂®Âã¢Ë©ïÂàÜ</div>
                <div class="ai-stock-name" id="ai-stock-name">2330 Âè∞Á©çÈõª</div>
                <div class="score bullish" id="ai-score">88</div>
                <div class="bar-container" id="ai-bars"></div>
            </div>
        </main>
    </div>

    <script>
        if (typeof LightweightCharts === 'undefined') {
            alert('ÂúñË°®Â∫´ËºâÂÖ•Â§±ÊïóÔºÅË´ãÊ™¢Êü• lightweight-charts.js ÊòØÂê¶Â≠òÂú®');
        }

        // === Seeded Random ===
        function seededRandom(seed) {
            let s = seed;
            return function() {
                s = (s * 16807 + 0) % 2147483647;
                return (s - 1) / 2147483646;
            };
        }

        function hashStr(str) {
            let hash = 5381;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        // === Stock Data ===
        const stocks = [
            { id: '2330', name: 'Âè∞Á©çÈõª', price: 1080.00, market: 'tw', basePrice: 1080, volatility: 0.03, trend: 0.002 },
            { id: '2317', name: 'È¥ªÊµ∑', price: 215.50, market: 'tw', basePrice: 215, volatility: 0.025, trend: 0.001 },
            { id: '2454', name: 'ËÅØÁôºÁßë', price: 1385.00, market: 'tw', basePrice: 1385, volatility: 0.035, trend: 0.0015 },
            { id: '2308', name: 'Âè∞ÈÅîÈõª', price: 415.00, market: 'tw', basePrice: 415, volatility: 0.028, trend: 0.001 },
            { id: '2881', name: 'ÂØåÈÇ¶Èáë', price: 92.30, market: 'tw', basePrice: 92, volatility: 0.02, trend: -0.0005 },
            { id: '2882', name: 'ÂúãÊ≥∞Èáë', price: 68.50, market: 'tw', basePrice: 68, volatility: 0.02, trend: 0.0003 },
            { id: '2603', name: 'Èï∑Ê¶Æ', price: 198.00, market: 'tw', basePrice: 198, volatility: 0.04, trend: -0.001 },
            { id: '3711', name: 'Êó•ÊúàÂÖâÊäïÊéß', price: 168.50, market: 'tw', basePrice: 168, volatility: 0.03, trend: 0.001 },
            { id: '2412', name: '‰∏≠ËèØÈõª', price: 132.50, market: 'tw', basePrice: 132, volatility: 0.012, trend: 0.0002 },
            { id: '2886', name: 'ÂÖÜË±êÈáë', price: 52.80, market: 'tw', basePrice: 52, volatility: 0.018, trend: 0.0004 },
            { id: '3037', name: 'Ê¨£Ëàà', price: 215.00, market: 'tw', basePrice: 215, volatility: 0.04, trend: 0.002 },
            { id: '2303', name: 'ËÅØÈõª', price: 52.10, market: 'tw', basePrice: 52, volatility: 0.03, trend: 0.0008 },
            { id: 'NVDA', name: 'ËºùÈÅî', price: 186.94, market: 'us', basePrice: 186, volatility: 0.04, trend: 0.003 },
            { id: 'TSLA', name: 'ÁâπÊñØÊãâ', price: 435.20, market: 'us', basePrice: 435, volatility: 0.05, trend: 0.001 },
            { id: 'AAPL', name: 'ËòãÊûú', price: 255.41, market: 'us', basePrice: 255, volatility: 0.02, trend: 0.001 },
        ];

        let activeStock = stocks[0];
        let activeFilter = 'tw';
        let charts = {};

        // === CTS (Composite Trend Score) Algorithm ===
        // Based on MA ‰∏âÈöéÂãïËÉΩ: Direction + Slope + Acceleration
        // Using tanh normalization to 0-100, with ATR & Volume weights

        function scoreTanh(x, scale) {
            if (scale <= 0) scale = 1;
            return 50 + 50 * Math.tanh(x / scale);
        }

        function regressionSlope(arr, n) {
            if (n < 2) return 0;
            let sumx = 0, sumy = 0, sumxy = 0, sumxx = 0;
            for (let i = 0; i < n; i++) {
                sumx += i; sumy += arr[i]; sumxy += i * arr[i]; sumxx += i * i;
            }
            const denom = n * sumxx - sumx * sumx;
            if (Math.abs(denom) < 1e-12) return 0;
            return (n * sumxy - sumx * sumy) / denom;
        }

        function calcATRWeight(atrArr, n) {
            if (n < 2) return 1;
            let sum = 0;
            for (let i = 0; i < n; i++) sum += atrArr[i];
            const avg = sum / n;
            if (avg < 1e-9) return 1;
            const w = 1 + Math.tanh((atrArr[0] - avg) / avg);
            return Math.max(0.5, Math.min(1.5, w));
        }

        function calcVolWeight(volArr, n) {
            if (n < 2) return 1;
            let sum = 0;
            for (let i = 0; i < n; i++) sum += volArr[i];
            const avg = sum / n;
            if (avg < 1e-9) return 1;
            const slope = regressionSlope(volArr, n);
            const w = 1 + Math.tanh(slope / avg);
            return Math.max(0.5, Math.min(1.5, w));
        }

        function calcOneMAScore(maArr, n, atrArr, nATR, volArr, nVol) {
            if (n < 3) return { score: 50, acc: 0 };
            const dir = maArr[0] - maArr[1];
            const ds = scoreTanh(dir, 0.8);
            const slopeNow = regressionSlope(maArr, n);
            const slopePrev = regressionSlope(maArr.slice(1), n - 1);
            const ss = scoreTanh(slopeNow, 0.4);
            const acc = slopeNow - slopePrev;
            const as = scoreTanh(acc, 0.2);
            let base = (ds + ss + as) / 3;
            const wATR = calcATRWeight(atrArr, nATR);
            const wVol = calcVolWeight(volArr, nVol);
            let final = base * wATR * wVol;
            return { score: Math.max(0, Math.min(100, final)), acc };
        }

        // Generate CTS from stock's OHLCV data
        function generateCTS(stock) {
            const rng = seededRandom(hashStr(stock.id + '_cts'));
            const count = 120;
            // Generate price series
            let price = stock.basePrice * (0.9 + rng() * 0.2);
            const closes = [], highs = [], lows = [], volumes = [];
            for (let i = 0; i < count; i++) {
                const open = price;
                const change = (rng() - 0.48 + stock.trend) * stock.volatility;
                const close = price * (1 + change);
                const high = Math.max(open, close) * (1 + rng() * 0.008);
                const low = Math.min(open, close) * (1 - rng() * 0.008);
                const vol = (rng() * 8000 + 2000) * (stock.basePrice / 100);
                closes.push(close); highs.push(high); lows.push(low); volumes.push(vol);
                price = close;
            }

            // Build newest-first arrays from end of series
            const N = 20; // window
            const newestCloses = closes.slice(-N).reverse();

            // Compute SMA series (newest first)
            function buildSMA(period, len) {
                const result = [];
                for (let i = 0; i < len && i + period <= closes.length; i++) {
                    const start = closes.length - 1 - i - period + 1;
                    if (start < 0) break;
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += closes[start + j];
                    result.push(sum / period);
                }
                return result;
            }

            const ma5 = buildSMA(5, 5);
            const ma10 = buildSMA(10, 5);
            const ma20 = buildSMA(20, 5);

            // ATR (True Range) newest-first
            const atrArr = [];
            for (let i = 0; i < 14 && closes.length - 1 - i > 0; i++) {
                const idx = closes.length - 1 - i;
                const tr = Math.max(
                    highs[idx] - lows[idx],
                    Math.abs(highs[idx] - closes[idx - 1]),
                    Math.abs(lows[idx] - closes[idx - 1])
                );
                atrArr.push(tr);
            }

            // Volume newest-first
            const volArr = volumes.slice(-14).reverse();

            // Calculate MA scores
            const s5 = calcOneMAScore(ma5, ma5.length, atrArr, atrArr.length, volArr, volArr.length);
            const s10 = calcOneMAScore(ma10, ma10.length, atrArr, atrArr.length, volArr, volArr.length);
            const s20 = calcOneMAScore(ma20, ma20.length, atrArr, atrArr.length, volArr, volArr.length);

            // CTS2 = weighted combination
            const cts2 = s5.score * 0.5 + s10.score * 0.3 + s20.score * 0.2;

            // Derive sub-indicators from the MA scores
            // Á±åÁ¢ºÈù¢ (chip) ‚âà volume-weighted momentum
            const chipScore = Math.max(0, Math.min(100, s5.score * 0.6 + s10.score * 0.4));
            // ÊäÄË°ìÈù¢ (tech) ‚âà MA trend alignment
            const techScore = Math.max(0, Math.min(100, s10.score * 0.5 + s20.score * 0.5));
            // Â∏ÇÂ†¥ÊÉÖÁ∑í ‚âà short-term acceleration
            const sentScore = Math.max(0, Math.min(100, scoreTanh(s5.acc * 10, 0.5)));

            const score = Math.round(Math.max(5, Math.min(99, cts2)));

            const labels = (v) => v >= 70 ? 'Âº∑Âã¢' : v >= 45 ? '‰∏≠Á´ã' : 'Âº±Âã¢';
            const techLabels = (v) => v >= 70 ? 'Â§öÈ†≠' : v >= 45 ? 'Áõ§Êï¥' : 'Á©∫È†≠';
            const sentLabels = (v) => v >= 65 ? 'Ê®ÇËßÄ' : v >= 40 ? '‰∏≠Á´ã' : 'ÊÇ≤ËßÄ';

            return {
                score,
                chip: { value: Math.round(chipScore), label: labels(chipScore) },
                tech: { value: Math.round(techScore), label: techLabels(techScore) },
                sentiment: { value: Math.round(sentScore), label: sentLabels(sentScore) },
            };
        }

        // === Multi-Timeframe CTS from OHLCV data ===
        function calcCTSFromOHLCV(ohlcvData) {
            // ohlcvData = array of {open, high, low, close} + volumeData
            const len = ohlcvData.data.length;
            if (len < 25) return { score: 50, direction: 0, chip: { value: 50, label: '‰∏≠Á´ã' }, tech: { value: 50, label: 'Áõ§Êï¥' }, sentiment: { value: 50, label: '‰∏≠Á´ã' } };

            const closes = ohlcvData.data.map(d => d.close);
            const highs = ohlcvData.data.map(d => d.high);
            const lows = ohlcvData.data.map(d => d.low);
            const volumes = ohlcvData.volumeData.map(d => d.value);

            // Build SMA (newest-first)
            function buildSMA(period, numPoints) {
                const result = [];
                for (let i = 0; i < numPoints && len - 1 - i - period + 1 >= 0; i++) {
                    const start = len - 1 - i;
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += closes[start - j];
                    result.push(sum / period);
                }
                return result;
            }

            const ma5 = buildSMA(5, 5);
            const ma10 = buildSMA(10, 5);
            const ma20 = buildSMA(20, 5);

            // ATR newest-first
            const atrArr = [];
            for (let i = 0; i < 14 && len - 1 - i > 0; i++) {
                const idx = len - 1 - i;
                const tr = Math.max(highs[idx] - lows[idx], Math.abs(highs[idx] - closes[idx - 1]), Math.abs(lows[idx] - closes[idx - 1]));
                atrArr.push(tr);
            }

            const volArr = volumes.slice(-14).reverse();

            const s5 = calcOneMAScore(ma5, ma5.length, atrArr, atrArr.length, volArr, volArr.length);
            const s10 = calcOneMAScore(ma10, ma10.length, atrArr, atrArr.length, volArr, volArr.length);
            const s20 = calcOneMAScore(ma20, ma20.length, atrArr, atrArr.length, volArr, volArr.length);

            const cts2 = s5.score * 0.5 + s10.score * 0.3 + s20.score * 0.2;
            const direction = cts2 >= 60 ? 1 : cts2 <= 40 ? -1 : 0; // 1=Â§ö, -1=Á©∫, 0=Áõ§Êï¥

            const chipScore = Math.max(0, Math.min(100, s5.score * 0.6 + s10.score * 0.4));
            const techScore = Math.max(0, Math.min(100, s10.score * 0.5 + s20.score * 0.5));
            const sentScore = Math.max(0, Math.min(100, scoreTanh(s5.acc * 10, 0.5)));

            const score = Math.round(Math.max(5, Math.min(99, cts2)));
            const labels = (v) => v >= 70 ? 'Âº∑Âã¢' : v >= 45 ? '‰∏≠Á´ã' : 'Âº±Âã¢';
            const techLabels = (v) => v >= 70 ? 'Â§öÈ†≠' : v >= 45 ? 'Áõ§Êï¥' : 'Á©∫È†≠';
            const sentLabels = (v) => v >= 65 ? 'Ê®ÇËßÄ' : v >= 40 ? '‰∏≠Á´ã' : 'ÊÇ≤ËßÄ';

            return {
                score, direction,
                chip: { value: Math.round(chipScore), label: labels(chipScore) },
                tech: { value: Math.round(techScore), label: techLabels(techScore) },
                sentiment: { value: Math.round(sentScore), label: sentLabels(sentScore) },
            };
        }

        // Multi-timeframe resonance: combine 3 CTS results
        function calcResonance(daily, hourly, min15) {
            const dirs = [daily.direction, hourly.direction, min15.direction];
            const allSame = dirs[0] !== 0 && dirs[0] === dirs[1] && dirs[1] === dirs[2];
            const allDiff = dirs[0] !== dirs[1] && dirs[1] !== dirs[2] && dirs[0] !== dirs[2];

            // Weighted average: daily 50%, 60min 30%, 15min 20%
            let baseScore = daily.score * 0.5 + hourly.score * 0.3 + min15.score * 0.2;

            let resonanceLevel, resonanceLabel;
            if (allSame) {
                // Strong resonance: boost by 10%
                baseScore = baseScore * 1.10;
                resonanceLevel = dirs[0] > 0 ? 'strong-bull' : 'strong-bear';
                resonanceLabel = dirs[0] > 0 ? 'üü¢ ‰∏âÈÄ±ÊúüÂÖ±ÊåØÂÅöÂ§ö' : 'üî¥ ‰∏âÈÄ±ÊúüÂÖ±ÊåØÂÅöÁ©∫';
            } else if (allDiff) {
                // Full divergence: dampen by 15%
                baseScore = 50 + (baseScore - 50) * 0.85;
                resonanceLevel = 'divergent';
                resonanceLabel = '‚ö™ ‰∏âÈÄ±ÊúüÂàÜÊ≠ß';
            } else {
                // Partial agreement
                const agree = dirs.filter(d => d === dirs[0]).length;
                if (agree >= 2) {
                    baseScore = baseScore * 1.05;
                }
                resonanceLevel = 'partial';
                resonanceLabel = 'üü° ÈÉ®ÂàÜÂÖ±ÊåØ';
            }

            const finalScore = Math.round(Math.max(5, Math.min(99, baseScore)));
            return { score: finalScore, resonanceLevel, resonanceLabel, dirs };
        }

        // Direction arrow helper
        function dirArrow(dir) {
            if (dir > 0) return '<span class="text-up">‚ñ≤ Â§ö</span>';
            if (dir < 0) return '<span class="text-down">‚ñº Á©∫</span>';
            return '<span style="color:#9ca3af">‚ñ¨ Áõ§Êï¥</span>';
        }

        // Alias for backward compat (fallback)
        function generateAIScore(stock) { return generateCTS(stock); }

        // === Chart Data Generation ===
        function generateOHLC(stock, suffix, count, intervalSec) {
            const rng = seededRandom(hashStr(stock.id + '_' + suffix));
            const data = [];
            const volumeData = [];
            const maData = [];
            let time = Math.floor(Date.now() / 1000) - count * intervalSec;
            let price = stock.basePrice * (0.9 + rng() * 0.2);

            for (let i = 0; i < count; i++) {
                const open = price;
                const change = (rng() - 0.48 + stock.trend) * stock.volatility;
                const close = price * (1 + change);
                const high = Math.max(open, close) * (1 + rng() * 0.008);
                const low = Math.min(open, close) * (1 - rng() * 0.008);
                const vol = (rng() * 8000 + 2000) * (stock.basePrice / 100);

                data.push({ time: time + i * intervalSec, open, high, low, close });
                volumeData.push({
                    time: time + i * intervalSec,
                    value: vol,
                    color: close >= open ? 'rgba(239, 68, 68, 0.5)' : 'rgba(34, 197, 94, 0.5)'
                });

                if (i >= 20) {
                    let sum = 0;
                    for (let j = 0; j < 20; j++) sum += data[i - j].close;
                    maData.push({ time: time + i * intervalSec, value: sum / 20 });
                }
                price = close;
            }
            return { data, volumeData, maData };
        }

        // === Create / Update Charts ===
        function destroyCharts() {
            ['daily', '1h', '15m'].forEach(key => {
                if (charts[key]) {
                    charts[key].chart.remove();
                    delete charts[key];
                }
            });
        }

        function createChart(id, candleData, volumeData, maData, withVolume) {
            const container = document.getElementById(id);
            if (!container) return null;

            const chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#111827' }, textColor: '#9ca3af' },
                grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
                timeScale: { borderColor: '#374151', timeVisible: true, rightOffset: 5 },
                rightPriceScale: { borderColor: '#374151' },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });

            const series = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#ef4444', downColor: '#22c55e',
                borderUpColor: '#ef4444', borderDownColor: '#22c55e',
                wickUpColor: '#ef4444', wickDownColor: '#22c55e',
            });
            series.setData(candleData);

            if (withVolume && maData.length) {
                const maLine = chart.addSeries(LightweightCharts.LineSeries, { color: '#facc15', lineWidth: 1, priceLineVisible: false });
                maLine.setData(maData);

                const volSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                    priceFormat: { type: 'volume' },
                    priceScaleId: '',
                    scaleMargins: { top: 0.8, bottom: 0 },
                });
                volSeries.setData(volumeData);
            }

            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container) return;
                const { width, height } = entries[0].contentRect;
                chart.applyOptions({ width, height });
            }).observe(container);

            return { chart, series };
        }

        function switchStock(stock) {
            activeStock = stock;
            destroyCharts();

            // Generate data for 3 timeframes
            const daily = generateOHLC(stock, 'daily', 120, 86400);
            const hourly = generateOHLC(stock, '1h', 100, 3600);
            const min15 = generateOHLC(stock, '15m', 100, 900);

            charts.daily = createChart('chart-daily', daily.data, daily.volumeData, daily.maData, true);
            charts['1h'] = createChart('chart-1h', hourly.data, hourly.volumeData, hourly.maData, false);
            charts['15m'] = createChart('chart-15m', min15.data, min15.volumeData, min15.maData, false);

            // Update badges
            document.getElementById('badge-daily').textContent = stock.id + ' Êó•Á∑ö';
            document.getElementById('badge-1h').textContent = stock.id + ' 60ÂàÜ';
            document.getElementById('badge-15m').textContent = stock.id + ' 15ÂàÜ';

            // Update AI panel ‚Äî Multi-Timeframe Resonance
            const ctsDaily = calcCTSFromOHLCV(daily);
            const ctsHourly = calcCTSFromOHLCV(hourly);
            const ctsMin15 = calcCTSFromOHLCV(min15);
            const resonance = calcResonance(ctsDaily, ctsHourly, ctsMin15);

            // Use daily CTS for sub-indicators, but resonance for overall score
            const ai = ctsDaily;
            ai.score = resonance.score;

            document.getElementById('ai-stock-name').textContent = stock.id + ' ' + stock.name;
            const scoreEl = document.getElementById('ai-score');
            scoreEl.textContent = ai.score;
            scoreEl.className = 'score ' + (ai.score >= 70 ? 'bullish' : ai.score >= 45 ? 'neutral' : 'bearish');

            const colorClass = (v) => v >= 65 ? 'fill-red' : v >= 35 ? 'fill-yellow' : 'fill-green';
            const textClass = (v) => v >= 65 ? 'text-up' : v >= 35 ? '' : 'text-down';
            
            document.getElementById('ai-bars').innerHTML = `
                <div class="bar-row" style="margin-bottom:6px;"><span style="font-size:11px;color:#d1d5db;">üì° ${resonance.resonanceLabel}</span></div>
                <div class="bar-row"><span style="font-size:11px;">Êó•Á∑ö</span>${dirArrow(resonance.dirs[0])}<span style="margin-left:8px;font-size:11px;">60ÂàÜ</span>${dirArrow(resonance.dirs[1])}<span style="margin-left:8px;font-size:11px;">15ÂàÜ</span>${dirArrow(resonance.dirs[2])}</div>
                <div style="border-top:1px solid #374151;margin:6px 0;"></div>
                <div class="bar-row"><span>Á±åÁ¢ºÈù¢</span><span class="${textClass(ai.chip.value)}">${ai.chip.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.chip.value)}" style="width: ${ai.chip.value}%"></div></div>
                <div class="bar-row"><span>ÊäÄË°ìÈù¢</span><span class="${textClass(ai.tech.value)}">${ai.tech.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.tech.value)}" style="width: ${ai.tech.value}%"></div></div>
                <div class="bar-row"><span>Â∏ÇÂ†¥ÊÉÖÁ∑í</span><span class="${textClass(ai.sentiment.value)}">${ai.sentiment.label}</span></div>
                <div class="progress-bg"><div class="progress-fill ${colorClass(ai.sentiment.value)}" style="width: ${ai.sentiment.value}%"></div></div>
            `;

            renderList();
        }

        // === Watchlist ===
        function renderList() {
            const el = document.getElementById('watchlist');
            if (!el) return;
            el.innerHTML = '';
            const filtered = activeFilter === 'all' ? stocks : stocks.filter(s => s.market === activeFilter);
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = `stock-row ${s.id === activeStock.id ? 'active' : ''}`;
                div.id = 'row-' + s.id;
                const changeVal = ((s.price - s.basePrice) / s.basePrice * 100);
                const changeStr = (changeVal >= 0 ? '+' : '') + changeVal.toFixed(2) + '%';
                const changeClass = changeVal >= 0 ? 'text-up' : 'text-down';
                div.innerHTML = `
                    <div class="stock-info">
                        <span class="symbol">${s.id}</span>
                        <span class="name">${s.name}</span>
                    </div>
                    <div class="price-box">
                        <div class="price ${changeClass}" id="price-${s.id}">${s.price.toFixed(2)}</div>
                        <div class="change ${changeClass}" id="change-${s.id}">${changeStr}</div>
                    </div>
                `;
                div.addEventListener('click', () => switchStock(s));
                el.appendChild(div);
            });
        }

        // === Tabs ===
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeFilter = tab.dataset.filter;
                renderList();
            });
        });

        // === Price Simulation (random subset each tick) ===
        setInterval(() => {
            // Each tick, randomly pick 1-3 stocks to update (more realistic)
            const count = Math.floor(Math.random() * 3) + 1;
            const shuffled = [...stocks].sort(() => Math.random() - 0.5);
            const toUpdate = shuffled.slice(0, count);
            toUpdate.forEach(s => {
                const oldPrice = s.price;
                s.price += (Math.random() - 0.48 + s.trend) * s.volatility * s.price * 0.1;
                const priceEl = document.getElementById('price-' + s.id);
                const changeEl = document.getElementById('change-' + s.id);
                const rowEl = document.getElementById('row-' + s.id);
                if (priceEl) {
                    priceEl.innerText = s.price.toFixed(2);
                    priceEl.className = `price ${s.price >= oldPrice ? 'text-up' : 'text-down'}`;
                }
                if (changeEl) {
                    const cv = ((s.price - s.basePrice) / s.basePrice * 100);
                    changeEl.innerText = (cv >= 0 ? '+' : '') + cv.toFixed(2) + '%';
                    changeEl.className = `change ${cv >= 0 ? 'text-up' : 'text-down'}`;
                }
                if (rowEl) {
                    const cls = s.price > oldPrice ? 'flash-up' : 'flash-down';
                    rowEl.classList.add(cls);
                    setTimeout(() => rowEl.classList.remove(cls), 500);
                }
            });
        }, 500);

        // === Init ===
        switchStock(stocks[0]);
    </script>
</body>
</html>
